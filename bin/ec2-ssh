#!/bin/sh
#/ Usage: ec2-ssh [-i private-key-file] <instance-name>
#/ Open ssh connection to EC2 instance where tag:Name=<instance-name>
#/ For a list of instances, run ec2-host without any parameters

set -e

test $# -eq 0 -o $(expr "$*" : ".*--help") \
				-ne 0 -o $(expr "$*" : ".*-h") -ne 0 && {
    grep ^#/ < $0 |
    cut -c4-
    exit
}

# Check if -k is given
if test "$1" = "-i"; then
  privatekeyfile="$2"
  hostchunk="$3"
else
  privatekeyfile=""
  hostchunk="$1"
fi

# support user@instance-name format
IFS="@"; declare -a hostparts=($hostchunk)

inst="${hostparts[1]}"
user="${hostparts[0]}"

if test -z "$inst"; then
	inst="$hostchunk"
	user="ubuntu"
fi

# get host from ec2-host command
host=$(ec2-host $inst)

# pass all other parameters (${@:2}) to ssh allowing
# things like: ec2-ssh nginx uptime
if test -n "$privatekeyfile"; then
  test -n "$host" && exec sh -c "ssh -i $privatekeyfile $user@$host ${@:4}"
else
  test -n "$host" && exec sh -c "ssh $user@$host ${@:2}"
fi
